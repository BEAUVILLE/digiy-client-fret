create or replace function public.rpc_fret_mark_paid(
  p_order_id text,
  p_method text,
  p_amount_xof integer,
  p_ref text,
  p_actor text
)
returns json
language plpgsql
security definer
as $$
declare
  v_price integer;
begin
  select price_xof into v_price
  from public.fret_orders
  where id = p_order_id
  limit 1;

  if v_price is null then
    raise exception 'ORDER_NOT_FOUND';
  end if;

  if p_amount_xof is null or p_amount_xof <= 0 then
    raise exception 'BAD_AMOUNT';
  end if;

  -- update order
  update public.fret_orders
  set payment_status = 'paid',
      payment_method = lower(p_method),
      paid_amount_xof = p_amount_xof,
      paid_at = now(),
      payment_ref = nullif(p_ref,''),
      updated_at = now()
  where id = p_order_id;

  -- log
  insert into public.fret_payment_logs(order_id, actor, method, amount_xof, status, ref, note)
  values (p_order_id, coalesce(nullif(p_actor,''),'client'), lower(p_method), p_amount_xof, 'paid', nullif(p_ref,''), 'Marked as paid');

  return json_build_object('ok', true, 'price_xof', v_price);
end;
$$;

grant execute on function public.rpc_fret_mark_paid(text,text,integer,text,text) to anon, authenticated;
